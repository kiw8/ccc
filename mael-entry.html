<?html
// 파일 경로: C:\xampp\htdocs\meal-entry.html
session_start();

// 사용자가 로그인하지 않은 경우 로그인 페이지로 리다이렉트
if (!isset($_SESSION['user_id'])) {
    header("Location: login.html");
    exit();
}

// 데이터베이스 연결 파일 포함
include('config.html');

// html 에러 표시 활성화 (개발 단계에서만 사용)
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // POST 요청에서 입력 데이터 가져오기
    $user_id = $_SESSION['user_id'];
    $food_name = trim($_POST['food_name']);

    if (empty($food_name)) {
        echo "<script>
alert('음식 이름을 입력해주세요.');
window.location.href = '../index.html';
</script>";
exit();
}

// 데이터베이스 연결 및 삽입 처리
$query = "INSERT INTO meal_records (user_id, food_name, record_date, calories)
SELECT ?, food_name, NOW(), calories
FROM food_search
WHERE food_name = ?";
$stmt = $conn->prepare($query);

if (!$stmt) {
// Prepare 실패 시 에러 메시지 표시 후 리다이렉트
echo "<script>
  alert('데이터베이스 쿼리 준비 중 오류가 발생했습니다: " . addslashes($conn->error) . "');
  window.location.href = '../index.html';
</script>";
exit();
}

$stmt->bind_param('is', $user_id, $food_name);

if ($stmt->execute()) {
if ($stmt->affected_rows > 0) {
// 삽입 성공 시 메시지 표시 후 리다이렉트
echo "<script>
  alert('식단 기록이 성공적으로 추가되었습니다.');
  window.location.href = '../index.html';
</script>";
} else {
// 음식 이름이 food_search에 없는 경우
echo "<script>
  alert('입력한 음식 이름이 데이터베이스에 존재하지 않습니다.');
  window.location.href = '../index.html';
</script>";
}
} else {
// 삽입 실패 시 에러 메시지 표시 후 리다이렉트
echo "<script>
  alert('오류가 발생했습니다: " . addslashes($stmt->error) . "');
  window.location.href = '../index.html';
</script>";
}

$stmt->close();
$conn->close();
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Responsive navbar-->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container px-5">
      <a class="navbar-brand" href="index.html">Autocal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="index.html">Home</a></li>
          <?html if ($isLoggedIn): ?>
          <li class="nav-item"><a class="nav-link" href="#"><?= htmlspecialchars($username) ?></a></li>
          <li class="nav-item"><a class="nav-link" href="pages/logout.html">Logout</a></li>
          <?html else: ?>
          <li class="nav-item"><a class="nav-link" href="pages/login.html">Login</a></li>
          <?html endif; ?>
        </ul>
      </div>
    </div>
  </nav>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>식단 입력</title>
  <link href="css/styles.css" rel="stylesheet">
</head>
<body>
<div class="container">
  <h1 class="mt-4">먹은 것 입력</h1>
  <form method="POST" action="">
    <div class="mb-3">
      <label for="food_name" class="form-label">음식 이름</label>
      <input type="text" class="form-control" id="food_name" name="food_name" required>
    </div>
    <button type="submit" class="btn btn-primary">기록 추가</button>
  </form>
</div>
<!-- Footer-->
<div>

</div>
</div>
<footer class="py-5 bg-dark">
  <div class="container px-4 px-lg-5"><p class="m-0 text-center text-white">Copyright &copy; Your Website 2023</p></div>
</footer>
<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core theme JS-->
<script src="js/scripts.js"></script>
</body>
</html>
